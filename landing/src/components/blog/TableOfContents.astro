---
interface Heading {
  depth: number;
  text: string;
  slug: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only h2 and h3
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <nav class="toc hidden lg:block sticky top-24" aria-label="Table of contents">
    <div class="border-l border-border pl-4">
      <h4 class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-4">
        On this page
      </h4>
      <ul class="space-y-2">
        {filteredHeadings.map((heading) => (
          <li
            class:list={[
              heading.depth === 3 && 'ml-3',
            ]}
          >
            <a
              href={`#${heading.slug}`}
              class="toc-link block text-sm text-muted-foreground hover:text-foreground transition-colors py-1"
              data-slug={heading.slug}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </nav>
)}

<script>
  // Highlight active ToC item on scroll
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = Array.from(tocLinks).map((link) => {
      const slug = link.getAttribute('data-slug');
      return document.getElementById(slug!);
    }).filter(Boolean);

    if (headings.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Remove active from all
            tocLinks.forEach((link) => link.classList.remove('text-foreground', 'font-medium'));

            // Add active to current
            const activeLink = document.querySelector(`.toc-link[data-slug="${entry.target.id}"]`);
            if (activeLink) {
              activeLink.classList.add('text-foreground', 'font-medium');
            }
          }
        });
      },
      {
        rootMargin: '-80px 0px -80% 0px',
        threshold: 0,
      }
    );

    headings.forEach((heading) => {
      if (heading) observer.observe(heading);
    });
  });
</script>

<style>
  .toc {
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }

  .toc-link {
    position: relative;
  }

  .toc-link::before {
    content: '';
    position: absolute;
    left: -1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: transparent;
    transition: background-color 0.2s;
  }

  .toc-link.text-foreground::before {
    background: theme('colors.primary.DEFAULT');
  }
</style>
