---
import type { GetStaticPaths } from 'astro';
import BlogLayout from '../../../../layouts/BlogLayout.astro';
import PostCard from '../../../../components/blog/PostCard.astro';
import Pagination from '../../../../components/blog/Pagination.astro';
import CategoryBadge from '../../../../components/blog/CategoryBadge.astro';
import { getPostsByCategory, paginate, getCategoriesWithCounts } from '../../../../lib/blog';
import { categories, type CategoryKey } from '../../../../content/config';

export const getStaticPaths: GetStaticPaths = async () => {
  const POSTS_PER_PAGE = 9;
  const categoryKeys = Object.keys(categories) as CategoryKey[];
  const paths = [];

  for (const category of categoryKeys) {
    const posts = await getPostsByCategory(category);
    const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);

    // Page 1 (index)
    paths.push({
      params: { category, page: undefined },
      props: { category, page: 1 },
    });

    // Additional pages
    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: { category, page: `page/${page}` },
        props: { category, page },
      });
    }
  }

  return paths;
};

interface Props {
  category: CategoryKey;
  page: number;
}

const { category, page } = Astro.props;
const POSTS_PER_PAGE = 9;

const categoryMeta = categories[category];
const categoryPosts = await getPostsByCategory(category);
const categoriesWithCounts = await getCategoriesWithCounts();

const { data: paginatedPosts, totalPages, currentPage } = paginate(categoryPosts, page, POSTS_PER_PAGE);

const isFirstPage = page === 1;
const title = isFirstPage
  ? `${categoryMeta.name} - Suparank Blog`
  : `${categoryMeta.name} - Page ${page} - Suparank Blog`;
const description = categoryMeta.description;
const canonical = isFirstPage
  ? `https://suparank.io/blog/category/${category}`
  : `https://suparank.io/blog/category/${category}/page/${page}`;
---

<BlogLayout
  title={title}
  description={description}
  metaTitle={isFirstPage ? `${categoryMeta.name} Articles | Suparank Blog` : `${categoryMeta.name} - Page ${page} | Suparank Blog`}
  metaDescription={description}
  canonical={canonical}
>
  <div class="container mx-auto px-6 py-12 md:py-16">
    <!-- Header -->
    <header class="mb-12 md:mb-16">
      <span class="section-label mb-3 block">Category</span>
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-semibold text-foreground mb-4">
        {categoryMeta.name}
      </h1>
      <p class="text-lg text-muted-foreground max-w-2xl">
        {categoryMeta.description}
      </p>
      <p class="text-sm text-muted-foreground mt-2">
        {categoryPosts.length} article{categoryPosts.length !== 1 ? 's' : ''}
      </p>
    </header>

    <!-- Category filters -->
    <div class="flex flex-wrap gap-2 mb-10">
      <a
        href="/blog"
        class="inline-flex items-center px-3 py-1.5 text-xs font-medium uppercase tracking-wider border border-border text-muted-foreground hover:text-foreground hover:border-muted-foreground/30 rounded-sm transition-colors"
      >
        All
      </a>
      {categoriesWithCounts.map((cat) => (
        <a
          href={`/blog/category/${cat.key}`}
          class:list={[
            'inline-flex items-center px-3 py-1.5 text-xs font-medium uppercase tracking-wider border rounded-sm transition-colors',
            cat.key === category
              ? 'border-primary bg-primary/10 text-primary'
              : 'border-border text-muted-foreground hover:text-foreground hover:border-muted-foreground/30',
          ]}
        >
          {cat.name}
          {cat.count > 0 && <span class="ml-1.5 text-muted-foreground/60">({cat.count})</span>}
        </a>
      ))}
    </div>

    <!-- Post Grid -->
    {paginatedPosts.length > 0 ? (
      <section>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
          {paginatedPosts.map((post) => (
            <PostCard post={post} />
          ))}
        </div>

        <Pagination
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl={`/blog/category/${category}`}
        />
      </section>
    ) : (
      <div class="text-center py-20">
        <p class="text-muted-foreground text-lg">No posts in this category yet.</p>
        <a href="/blog" class="text-primary hover:text-primary-light transition-colors mt-4 inline-block">
          ‚Üê Back to all posts
        </a>
      </div>
    )}
  </div>
</BlogLayout>
