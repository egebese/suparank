---
import BlogLayout from '../../layouts/BlogLayout.astro';
import FeaturedPost from '../../components/blog/FeaturedPost.astro';
import PostCard from '../../components/blog/PostCard.astro';
import CategoryBadge from '../../components/blog/CategoryBadge.astro';
import Pagination from '../../components/blog/Pagination.astro';
import { getPublishedPosts, getFeaturedPosts, getCategoriesWithCounts, paginate } from '../../lib/blog';
import { categories, type CategoryKey } from '../../content/config';

const POSTS_PER_PAGE = 9;

const allPosts = await getPublishedPosts();
const featuredPosts = await getFeaturedPosts();
const categoriesWithCounts = await getCategoriesWithCounts();

// Get featured post (most recent featured, or most recent post)
const featuredPost = featuredPosts[0] || allPosts[0];

// Get remaining posts (excluding featured)
const remainingPosts = allPosts.filter((post) => post.id !== featuredPost?.id);

// Paginate remaining posts
const { data: paginatedPosts, totalPages, currentPage } = paginate(remainingPosts, 1, POSTS_PER_PAGE);

const title = 'Blog - Suparank';
const description = 'Insights, guides, and updates on SEO, content strategy, and AI-powered content creation.';
---

<BlogLayout
  title={title}
  description={description}
  metaTitle="Suparank Blog | SEO Insights, Guides & Content Strategy"
  metaDescription={description}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Blog",
      "name": "Suparank Blog",
      "description": description,
      "url": "https://suparank.io/blog",
      "publisher": {
        "@type": "Organization",
        "name": "Suparank",
        "logo": {
          "@type": "ImageObject",
          "url": "https://suparank.io/branding/logo-light.png"
        }
      }
    })} />
  </Fragment>

  <div class="container mx-auto px-6 py-12 md:py-16">
    <!-- Header -->
    <header class="mb-12 md:mb-16">
      <span class="section-label mb-3 block">Blog</span>
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-semibold text-foreground mb-4">
        Insights, guides, and updates<br class="hidden sm:block" />
        for modern builders
      </h1>
      <p class="text-lg text-muted-foreground max-w-2xl">
        Stay ahead with deep-dive articles on automation, AI workflows, developer tooling, and updates.
      </p>
    </header>

    <!-- Category filters -->
    <div class="flex flex-wrap gap-2 mb-10">
      <a
        href="/blog"
        class="inline-flex items-center px-3 py-1.5 text-xs font-medium uppercase tracking-wider border border-primary bg-primary/10 text-primary rounded-sm"
      >
        All
      </a>
      {categoriesWithCounts.map((cat) => (
        <a
          href={`/blog/category/${cat.key}`}
          class="inline-flex items-center px-3 py-1.5 text-xs font-medium uppercase tracking-wider border border-border text-muted-foreground hover:text-foreground hover:border-muted-foreground/30 rounded-sm transition-colors"
        >
          {cat.name}
          {cat.count > 0 && <span class="ml-1.5 text-muted-foreground/60">({cat.count})</span>}
        </a>
      ))}
    </div>

    <!-- Featured Post -->
    {featuredPost && (
      <section class="mb-16 pb-16 border-b border-border">
        <FeaturedPost post={featuredPost} />
      </section>
    )}

    <!-- Post Grid -->
    {paginatedPosts.length > 0 && (
      <section>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
          {paginatedPosts.map((post) => (
            <PostCard post={post} />
          ))}
        </div>

        <Pagination
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl="/blog"
        />
      </section>
    )}

    <!-- Empty state -->
    {allPosts.length === 0 && (
      <div class="text-center py-20">
        <p class="text-muted-foreground text-lg">No posts yet. Check back soon!</p>
      </div>
    )}
  </div>
</BlogLayout>
